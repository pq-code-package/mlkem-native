# Copyright (c) The mldsa-native project authors
# Copyright (c) The mlkem-native project authors
# SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT

name: Baremetal
permissions:
  contents: read
on:
  workflow_call:
  workflow_dispatch:

jobs:
  baremetal_tests:
    name: Baremetal tests (${{ matrix.target.name }})
    strategy:
      fail-fast: false
      matrix:
        target:
         - runner: ubuntu-latest
           name: 'M55-AN547'
           makefile: test/baremetal/platform/m55-an547/platform.mk
           nix-shell: cross-arm-embedded
           func: true
           kat: true
           acvp: true
           alloc: true
           bench: true
           opt: all
         - runner: ubuntu-latest
           name: 'M33-AN524'
           makefile: test/baremetal/platform/m33-an524/platform.mk
           nix-shell: cross-arm-embedded
           func: true
           kat: true
           acvp: true
           alloc: true
           bench: true
           opt: all
         - runner: ubuntu-latest
           name: 'AVR ATmega128RFR2 (modified for 32K RAM)'
           makefile: test/baremetal/platform/avr/platform.mk
           nix-shell: cross-avr
           func: true
           kat: true
           acvp: true
           alloc: false
           bench: false
           opt: no_opt
    runs-on: ${{ matrix.target.runner }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: baremetal build + test
        uses: ./.github/actions/functest
        env:
          EXTRA_MAKEFILE: ${{ matrix.target.makefile }}
        with:
          nix-shell: ${{ matrix.target.nix-shell }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          opt: ${{ matrix.target.opt }}
          func: ${{ matrix.target.func }}
          kat: ${{ matrix.target.kat }}
          acvp: ${{ matrix.target.acvp }}
          examples: false
          stack: false
          alloc: ${{ matrix.target.alloc }}
          rng_fail: true
      - name: Baremetal bench
        if: ${{ matrix.target.bench }}
        uses: ./.github/actions/bench
        env:
          EXTRA_MAKEFILE: ${{ matrix.target.makefile }}
        with:
          name: ${{ matrix.target.name }}
          nix-shell: ${{ matrix.target.nix-shell }}
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          perf: PMU
          opt: true
          store_results: false

  baremetal_aarch64_virt:
    name: AArch64-virt no-MMU (${{ matrix.fips202_backend }})
    strategy:
      fail-fast: false
      matrix:
        fips202_backend:
          - x1_scalar
          - x1_v84a
          - x2_v84a
          - x4_v8a_scalar
          - x4_v8a_v84a_scalar
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: baremetal build + test
        uses: ./.github/actions/functest
        env:
          EXTRA_MAKEFILE: test/baremetal/platform/aarch64-virt/platform.mk
        with:
          nix-shell: cross-aarch64-embedded
          gh_token: ${{ secrets.GITHUB_TOKEN }}
          opt: opt
          func: true
          kat: true
          acvp: true
          examples: false
          stack: false
          alloc: false
          rng_fail: true
          extra_args: '--fips202-aarch64-backend=${{ matrix.fips202_backend }}'
