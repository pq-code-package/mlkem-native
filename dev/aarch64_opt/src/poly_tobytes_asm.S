/*
 * Copyright (c) 2024-2025 The mlkem-native project authors
 * SPDX-License-Identifier: Apache-2.0
 */

#include "../../../common.h"
#if defined(MLK_ARITH_BACKEND_AARCH64) &&  !defined(MLK_MULTILEVEL_BUILD_NO_SHARED)
/* simpasm: header-end */

.macro ld2_wrap a, ptr
        ldr q_tmp0, [\ptr\()], #32
        ldr q_tmp1, [\ptr\(), #-16]
        uzp1 \a\()0.8h, tmp0.8h, tmp1.8h
        uzp2 \a\()1.8h, tmp0.8h, tmp1.8h
.endm

/********************************************
 *         mlk_poly_tobytes()               *
 ********************************************/

        data0  .req v0
        data1  .req v1
        out0   .req v2
        out1   .req v3
        out2   .req v4
        tmp0   .req v5
        tmp1   .req v6
        q_tmp0 .req q5
        q_tmp1 .req q6

        dst   .req x0
        src   .req x1
        count .req x2

        .text
        .global MLK_ASM_NAMESPACE(poly_tobytes_asm)
        .balign 4
MLK_ASM_FN_SYMBOL(poly_tobytes_asm)

        mov count, #16
                                   // Instructions:    8
                                   // Expected cycles: 15
                                   // Expected IPC:    0.53
                                   //
                                   // Cycle bound:     15.0
                                   // IPC bound:       0.53
                                   //
                                   // Wall time:     0.01s
                                   // User time:     0.01s
                                   //
                                   // ----- cycle (expected) ------>
                                   // 0                        25
                                   // |------------------------|----
        ldr q6, [x1], #32          // *.............................
        ldr q24, [x1, #-16]        // ..*...........................
        ldr q30, [x1], #32         // ....*.........................
        ldr q22, [x1, #-16]        // ......*.......................
        ldr q5, [x1], #32          // ........*.....................
        ldr q17, [x1, #-16]        // ..........*...................
        ldr q19, [x1], #32         // ............*.................
        ldr q4, [x1, #-16]         // ..............*...............

                                    // ------ cycle (expected) ------>
                                    // 0                        25
                                    // |------------------------|-----
        // ldr q6, [x1], #32        // *..............................
        // ldr q24, [x1, #-16]      // ..*............................
        // ldr q30, [x1], #32       // ....*..........................
        // ldr q22, [x1, #-16]      // ......*........................
        // ldr q5, [x1], #32        // ........*......................
        // ldr q17, [x1, #-16]      // ..........*....................
        // ldr q19, [x1], #32       // ............*..................
        // ldr q4, [x1, #-16]       // ..............*................

        lsr count, count, #2
        sub count, count, #1
poly_tobytes_asm_asm_loop_start:
                                                       // Instructions:    40
                                                       // Expected cycles: 68
                                                       // Expected IPC:    0.59
                                                       //
                                                       // Cycle bound:     68.0
                                                       // IPC bound:       0.59
                                                       //
                                                       // Wall time:     176.66s
                                                       // User time:     176.66s
                                                       //
                                                       // ------------------------ cycle (expected) ------------------------->
                                                       // 0                        25                       50
                                                       // |------------------------|------------------------|-----------------
        uzp1 v25.8H, v6.8H, v24.8H                     // *...................................................................
        uzp2 v6.8H, v6.8H, v24.8H                      // .*..................................................................
        xtn v24.8B, v25.8H                             // ..*.................................................................
        shrn v25.8B, v25.8H, #8                        // ...*................................................................
        xtn v18.8B, v6.8H                              // .....*..............................................................
        shrn v26.8B, v6.8H, #4                         // ......*.............................................................
        sli v25.8B, v18.8B, #4                         // ........*...........................................................
        st3 {v24.8B, v25.8B, v26.8B}, [x0], #24        // ..........*.........................................................
        uzp1 v25.8H, v30.8H, v22.8H                    // .............*......................................................
        uzp2 v6.8H, v30.8H, v22.8H                     // ..............*.....................................................
        xtn v24.8B, v25.8H                             // ...............*....................................................
        xtn v18.8B, v6.8H                              // ................*...................................................
        uzp1 v30.8H, v5.8H, v17.8H                     // .................*..................................................
        uzp2 v22.8H, v5.8H, v17.8H                     // ..................*.................................................
        xtn v5.8B, v30.8H                              // ...................*................................................
        xtn v17.8B, v22.8H                             // ....................*...............................................
        uzp1 v28.8H, v19.8H, v4.8H                     // .....................*..............................................
        uzp2 v19.8H, v19.8H, v4.8H                     // ......................*.............................................
        xtn v4.8B, v28.8H                              // .......................*............................................
        xtn v20.8B, v19.8H                             // ........................*...........................................
        shrn v25.8B, v25.8H, #8                        // .........................*..........................................
        sli v25.8B, v18.8B, #4                         // ...........................*........................................
        shrn v26.8B, v6.8H, #4                         // .............................*......................................
        st3 {v24.8B, v25.8B, v26.8B}, [x0], #24        // ...............................*....................................
        shrn v6.8B, v30.8H, #8                         // ..................................*.................................
        sli v6.8B, v17.8B, #4                          // ....................................*...............................
        shrn v7.8B, v22.8H, #4                         // ......................................*.............................
        st3 {v5.8B, v6.8B, v7.8B}, [x0], #24           // ........................................*...........................
        shrn v5.8B, v28.8H, #8                         // ...........................................*........................
        shrn v6.8B, v19.8H, #4                         // .............................................*......................
        sli v5.8B, v20.8B, #4                          // ...............................................*....................
        st3 {v4.8B, v5.8B, v6.8B}, [x0], #24           // .................................................*..................
        ldr q6, [x1], #32                              // ....................................................e...............
        ldr q24, [x1, #-16]                            // ......................................................e.............
        ldr q30, [x1], #32                             // ........................................................e...........
        ldr q22, [x1, #-16]                            // ..........................................................e.........
        ldr q5, [x1], #32                              // ............................................................e.......
        ldr q17, [x1, #-16]                            // ..............................................................e.....
        ldr q19, [x1], #32                             // ................................................................e...
        ldr q4, [x1, #-16]                             // ..................................................................e.

                                                     // ----------------------- cycle (expected) ------------------------>
                                                     // 0                        25                       50
                                                     // |------------------------|------------------------|---------------
        // ldr q5, [x1], #32                         // e...............'.................................................
        // ldr q6, [x1, #-16]                        // ..e.............'.................................................
        // uzp1 v0.8h, v5.8h, v6.8h                  // ................*.................................................
        // uzp2 v1.8h, v5.8h, v6.8h                  // ................'*................................................
        // xtn v2.8b, v0.8h                          // ................'.*...............................................
        // shrn v3.8b, v0.8h, #8                     // ................'..*..............................................
        // xtn v5.8b, v1.8h                          // ................'....*............................................
        // sli v3.8b, v5.8b, #4                      // ................'.......*.........................................
        // shrn v4.8b, v1.8h, #4                     // ................'.....*...........................................
        // st3 {v2.8b, v3.8b, v4.8b}, [x0], #24      // ................'.........*.......................................
        // ldr q5, [x1], #32                         // ....e...........'.................................................
        // ldr q6, [x1, #-16]                        // ......e.........'.................................................
        // uzp1 v0.8h, v5.8h, v6.8h                  // ................'............*....................................
        // uzp2 v1.8h, v5.8h, v6.8h                  // ................'.............*...................................
        // xtn v2.8b, v0.8h                          // ................'..............*..................................
        // shrn v3.8b, v0.8h, #8                     // ................'........................*........................
        // xtn v5.8b, v1.8h                          // ................'...............*.................................
        // sli v3.8b, v5.8b, #4                      // ................'..........................*......................
        // shrn v4.8b, v1.8h, #4                     // ................'............................*....................
        // st3 {v2.8b, v3.8b, v4.8b}, [x0], #24      // ................'..............................*..................
        // ldr q5, [x1], #32                         // ........e.......'.................................................
        // ldr q6, [x1, #-16]                        // ..........e.....'.................................................
        // uzp1 v0.8h, v5.8h, v6.8h                  // ................'................*................................
        // uzp2 v1.8h, v5.8h, v6.8h                  // ................'.................*...............................
        // xtn v2.8b, v0.8h                          // ................'..................*..............................
        // shrn v3.8b, v0.8h, #8                     // ................'.................................*...............
        // xtn v5.8b, v1.8h                          // ................'...................*.............................
        // sli v3.8b, v5.8b, #4                      // ................'...................................*.............
        // shrn v4.8b, v1.8h, #4                     // ................'.....................................*...........
        // st3 {v2.8b, v3.8b, v4.8b}, [x0], #24      // ................'.......................................*.........
        // ldr q5, [x1], #32                         // ............e...'.................................................
        // ldr q6, [x1, #-16]                        // ..............e.'.................................................
        // uzp1 v0.8h, v5.8h, v6.8h                  // ................'....................*............................
        // uzp2 v1.8h, v5.8h, v6.8h                  // ................'.....................*...........................
        // xtn v2.8b, v0.8h                          // ................'......................*..........................
        // shrn v3.8b, v0.8h, #8                     // ................'..........................................*......
        // xtn v5.8b, v1.8h                          // ................'.......................*.........................
        // sli v3.8b, v5.8b, #4                      // ................'..............................................*..
        // shrn v4.8b, v1.8h, #4                     // ................'............................................*....
        // st3 {v2.8b, v3.8b, v4.8b}, [x0], #24      // ................'................................................*

        sub count, count, 1
        cbnz count, poly_tobytes_asm_asm_loop_start
                                                       // Instructions:    32
                                                       // Expected cycles: 50
                                                       // Expected IPC:    0.64
                                                       //
                                                       // Cycle bound:     50.0
                                                       // IPC bound:       0.64
                                                       //
                                                       // Wall time:     0.20s
                                                       // User time:     0.20s
                                                       //
                                                       // --------------- cycle (expected) ---------------->
                                                       // 0                        25
                                                       // |------------------------|
        uzp1 v25.8H, v30.8H, v22.8H                    // *.................................................
        uzp2 v18.8H, v30.8H, v22.8H                    // .*................................................
        uzp1 v30.8H, v6.8H, v24.8H                     // ..*...............................................
        uzp2 v6.8H, v6.8H, v24.8H                      // ...*..............................................
        uzp1 v24.8H, v5.8H, v17.8H                     // ....*.............................................
        uzp2 v22.8H, v5.8H, v17.8H                     // .....*............................................
        uzp1 v5.8H, v19.8H, v4.8H                      // ......*...........................................
        uzp2 v17.8H, v19.8H, v4.8H                     // .......*..........................................
        xtn v19.8B, v25.8H                             // ........*.........................................
        shrn v20.8B, v25.8H, #8                        // .........*........................................
        xtn v25.8B, v18.8H                             // ...........*......................................
        shrn v21.8B, v18.8H, #4                        // ............*.....................................
        xtn v28.8B, v30.8H                             // ..............*...................................
        shrn v29.8B, v30.8H, #8                        // ...............*..................................
        xtn v18.8B, v6.8H                              // .................*................................
        shrn v30.8B, v6.8H, #4                         // ..................*...............................
        xtn v1.8B, v24.8H                              // ....................*.............................
        shrn v2.8B, v24.8H, #8                         // .....................*............................
        xtn v6.8B, v22.8H                              // .......................*..........................
        shrn v3.8B, v22.8H, #4                         // ........................*.........................
        xtn v22.8B, v5.8H                              // ..........................*.......................
        shrn v23.8B, v5.8H, #8                         // ...........................*......................
        xtn v5.8B, v17.8H                              // .............................*....................
        shrn v24.8B, v17.8H, #4                        // ..............................*...................
        sli v20.8B, v25.8B, #4                         // ................................*.................
        sli v29.8B, v18.8B, #4                         // ..................................*...............
        st3 {v28.8B, v29.8B, v30.8B}, [x0], #24        // ....................................*.............
        st3 {v19.8B, v20.8B, v21.8B}, [x0], #24        // .......................................*..........
        sli v2.8B, v6.8B, #4                           // ..........................................*.......
        st3 {v1.8B, v2.8B, v3.8B}, [x0], #24           // ............................................*.....
        sli v23.8B, v5.8B, #4                          // ...............................................*..
        st3 {v22.8B, v23.8B, v24.8B}, [x0], #24        // .................................................*

                                                        // --------------- cycle (expected) ---------------->
                                                        // 0                        25
                                                        // |------------------------|------------------------
        // uzp1 v25.8H, v6.8H, v24.8H                   // ..*...............................................
        // uzp2 v6.8H, v6.8H, v24.8H                    // ...*..............................................
        // xtn v24.8B, v25.8H                           // ..............*...................................
        // shrn v25.8B, v25.8H, #8                      // ...............*..................................
        // xtn v18.8B, v6.8H                            // .................*................................
        // shrn v26.8B, v6.8H, #4                       // ..................*...............................
        // sli v25.8B, v18.8B, #4                       // ..................................*...............
        // st3 {v24.8B, v25.8B, v26.8B}, [x0], #24      // ....................................*.............
        // uzp1 v25.8H, v30.8H, v22.8H                  // *.................................................
        // uzp2 v6.8H, v30.8H, v22.8H                   // .*................................................
        // xtn v24.8B, v25.8H                           // ........*.........................................
        // xtn v18.8B, v6.8H                            // ...........*......................................
        // uzp1 v30.8H, v5.8H, v17.8H                   // ....*.............................................
        // uzp2 v22.8H, v5.8H, v17.8H                   // .....*............................................
        // xtn v5.8B, v30.8H                            // ....................*.............................
        // xtn v17.8B, v22.8H                           // .......................*..........................
        // uzp1 v28.8H, v19.8H, v4.8H                   // ......*...........................................
        // uzp2 v19.8H, v19.8H, v4.8H                   // .......*..........................................
        // xtn v4.8B, v28.8H                            // ..........................*.......................
        // xtn v20.8B, v19.8H                           // .............................*....................
        // shrn v25.8B, v25.8H, #8                      // .........*........................................
        // sli v25.8B, v18.8B, #4                       // ................................*.................
        // shrn v26.8B, v6.8H, #4                       // ............*.....................................
        // st3 {v24.8B, v25.8B, v26.8B}, [x0], #24      // .......................................*..........
        // shrn v6.8B, v30.8H, #8                       // .....................*............................
        // sli v6.8B, v17.8B, #4                        // ..........................................*.......
        // shrn v7.8B, v22.8H, #4                       // ........................*.........................
        // st3 {v5.8B, v6.8B, v7.8B}, [x0], #24         // ............................................*.....
        // shrn v5.8B, v28.8H, #8                       // ...........................*......................
        // shrn v6.8B, v19.8H, #4                       // ..............................*...................
        // sli v5.8B, v20.8B, #4                        // ...............................................*..
        // st3 {v4.8B, v5.8B, v6.8B}, [x0], #24         // .................................................*

        ret

        .unreq data0
        .unreq data1
        .unreq out0
        .unreq out1
        .unreq out2
        .unreq tmp0
        .unreq tmp1
        .unreq q_tmp0
        .unreq q_tmp1
        .unreq dst
        .unreq src
        .unreq count

/* simpasm: footer-start */
#endif /* MLK_ARITH_BACKEND_AARCH64 && !MLK_MULTILEVEL_BUILD_NO_SHARED */
