/*
 * Copyright (c) The mlkem-native project authors
 * SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT
 */

/* NOTE: You can remove this file unless you compile with MLKEM_DEBUG. */

#include "../../../common.h"

#if defined(MLK_ARITH_BACKEND_RISCV64) && \
    !defined(MLK_CONFIG_MULTILEVEL_NO_SHARED) && defined(MLKEM_DEBUG)

#include <stdio.h>
#include <stdlib.h>

#include "../../../debug.h"
#include "rv64v_debug.h"

#define MLK_DEBUG_ERROR_HEADER "[ERROR:%s:%04d] "

/*************************************************
 * Name:        mlk_debug_check_bounds_int16m1
 *
 * Description: Check whether values in a vint16m1_t vector
 *              are within specified bounds.
 *
 * Implementation: Extract vector elements to a temporary array
 *                and reuse existing array bounds checking.
 **************************************************/
void mlk_debug_check_bounds_int16m1(const char *file, int line, vint16m1_t vec,
                                    size_t vl, int lower_bound_exclusive,
                                    int upper_bound_exclusive)
{
  /* Allocate temporary array to store vector elements
   * We use the maximum possible vector length to be safe */
  int16_t temp_array[64];

  /* Store vector elements to temporary array for inspection */
  __riscv_vse16_v_i16m1(temp_array, vec, vl);

  /* Reuse existing array bounds checking function */
  mlk_debug_check_bounds(file, line, temp_array, (unsigned)vl,
                         lower_bound_exclusive, upper_bound_exclusive);
}

/*************************************************
 * Name:        mlk_debug_check_bounds_int16m2
 *
 * Description: Check whether values in a vint16m2_t vector
 *              are within specified bounds.
 *
 * Implementation: Extract vector elements to a temporary array
 *                and reuse existing array bounds checking.
 **************************************************/
void mlk_debug_check_bounds_int16m2(const char *file, int line, vint16m2_t vec,
                                    size_t vl, int lower_bound_exclusive,
                                    int upper_bound_exclusive)
{
  /* Allocate temporary array to store vector elements
   * m2 vectors hold 2x the elements of m1 vectors */
  int16_t temp_array[2 * 64];

  /* Store vector elements to temporary array for inspection */
  __riscv_vse16_v_i16m2(temp_array, vec, 2 * vl);

  /* Reuse existing array bounds checking function for all elements */
  mlk_debug_check_bounds(file, line, temp_array, (unsigned)(2 * vl),
                         lower_bound_exclusive, upper_bound_exclusive);
}

#else /* MLK_ARITH_BACKEND_RISCV64 && !MLK_CONFIG_MULTILEVEL_NO_SHARED && \
         MLKEM_DEBUG */

MLK_EMPTY_CU(rv64v_debug)

#endif /* !(MLK_ARITH_BACKEND_RISCV64 && !MLK_CONFIG_MULTILEVEL_NO_SHARED && \
          MLKEM_DEBUG) */

/* To facilitate single-compilation-unit (SCU) builds, undefine all macros.
 * Don't modify by hand -- this is auto-generated by scripts/autogen. */
#undef MLK_DEBUG_ERROR_HEADER
