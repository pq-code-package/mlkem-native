// Copyright (c) 2022 Arm Limited
// Copyright (c) 2022 Hanno Becker
// Copyright (c) 2023 Amin Abdulrahman, Matthias Kannwischer
// Copyright (c) 2024 The mlkem-native project authors
// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
// SPDX-License-Identifier: MIT

// ----------------------------------------------------------------------------
// Inverse number-theoretic transform from ML-KEM
// Input a[256], z_01234[80], z_56[384] (all signed 16-bit words); output a[256] (signed 16-bit words).
//
// The transform is in-place with input and output a[256], with the input in
// bitreversed order and the output mapped into the Montgomery domain via
// x |-> (2^16 * x) mod 3329. The two other parameters are expected to point to
// tables of constants whose definitions can be found in the mlkem-native
// repo (mlkem/native/aarch64/src/aarch64_zetas.c) or our "tests/test.c".
//
// extern void mlkem_intt(int16_t a[256],int16_t z_01234[80],int16_t z_56[384]);
//
// Standard ARM ABI: X0 = a, X1 = z_01234, X2 = z_56
// ----------------------------------------------------------------------------
#include "_internal_s2n_bignum.h"

        S2N_BN_SYM_VISIBILITY_DIRECTIVE(mlkem_intt)
        S2N_BN_SYM_PRIVACY_DIRECTIVE(mlkem_intt)
        .text
        .balign 4

S2N_BN_SYMBOL(mlkem_intt):

// This implementation is generated by SLOTHY, set up to optimize for
// the Neoverse N1 microarchitecture, starting from the clean version
//
//   https://github.com/pq-code-package/mlkem-native/blob/main/mlkem/native/aarch64/intt_clean.S
//
// in the mlkem-native repository.

PQCP_MLKEM_NATIVE_MLKEM512_intt_asm_opt:
                                sub     sp, sp, #0x40
                                stp     d8, d9, [sp]
                                stp     d10, d11, [sp, #16]
                                stp     d12, d13, [sp, #32]
                                stp     d14, d15, [sp, #48]
                                mov     w5, #0xd01
                                mov     v7.h[0], w5
                                mov     w5, #0x4ebf
                                mov     v7.h[1], w5
                                mov     w5, #0x200
                                dup     v29.8h, w5
                                mov     w5, #0x13b0
                                dup     v30.8h, w5
                                mov     x3, x0
                                mov     x4, #0x8

scale_start:
                                ldr     q8, [x3]
                                ldr     q9, [x3, #16]
                                ldr     q10, [x3, #32]
                                ldr     q11, [x3, #48]
                                sqrdmulh        v27.8h, v8.8h, v30.8h
                                mul     v8.8h, v8.8h, v29.8h
                                mls     v8.8h, v27.8h, v7.h[0]
                                sqrdmulh        v27.8h, v9.8h, v30.8h
                                mul     v9.8h, v9.8h, v29.8h
                                mls     v9.8h, v27.8h, v7.h[0]
                                sqrdmulh        v27.8h, v10.8h, v30.8h
                                mul     v10.8h, v10.8h, v29.8h
                                mls     v10.8h, v27.8h, v7.h[0]
                                sqrdmulh        v27.8h, v11.8h, v30.8h
                                mul     v11.8h, v11.8h, v29.8h
                                mls     v11.8h, v27.8h, v7.h[0]
                                str     q8, [x3], #64
                                stur    q9, [x3, #-48]
                                stur    q10, [x3, #-32]
                                stur    q11, [x3, #-16]
                                subs    x4, x4, #0x1
                                cbnz    x4, scale_start
                                mov     x3, x0
                                mov     x4, #0x8
                                ldr     q26, [x3]
                                ldr     q8, [x3, #16]
                                ldr     q24, [x3, #32]
                                ldr     q16, [x3, #48]
                                ldr     q9, [x2], #96
                                trn1    v0.4s, v24.4s, v16.4s
                                ldur    q6, [x2, #-80]
                                ldur    q3, [x2, #-64]
                                ldur    q15, [x2, #-48]
                                ldur    q4, [x2, #-32]
                                ldur    q28, [x2, #-16]
                                sub     x4, x4, #0x1

layer3456_start:
                                trn1    v12.4s, v26.4s, v8.4s
                                trn2    v26.4s, v26.4s, v8.4s
                                trn2    v8.4s, v24.4s, v16.4s
                                trn2    v11.2d, v12.2d, v0.2d
                                trn1    v12.2d, v12.2d, v0.2d
                                trn2    v16.2d, v26.2d, v8.2d
                                trn1    v26.2d, v26.2d, v8.2d
                                sub     v8.8h, v11.8h, v16.8h
                                add     v11.8h, v11.8h, v16.8h
                                sub     v16.8h, v12.8h, v26.8h
                                add     v12.8h, v12.8h, v26.8h
                                sqrdmulh        v26.8h, v8.8h, v28.8h
                                sqrdmulh        v15.8h, v16.8h, v15.8h
                                mul     v16.8h, v16.8h, v3.8h
                                mul     v8.8h, v8.8h, v4.8h
                                sub     v0.8h, v12.8h, v11.8h
                                add     v12.8h, v12.8h, v11.8h
                                mls     v16.8h, v15.8h, v7.h[0]
                                mls     v8.8h, v26.8h, v7.h[0]
                                sqrdmulh        v26.8h, v0.8h, v6.8h
                                mul     v11.8h, v0.8h, v9.8h
                                ldr     q15, [x1], #16
                                sub     v0.8h, v16.8h, v8.8h
                                mls     v11.8h, v26.8h, v7.h[0]
                                add     v26.8h, v16.8h, v8.8h
                                sqrdmulh        v8.8h, v0.8h, v6.8h
                                mul     v16.8h, v0.8h, v9.8h
                                trn1    v0.4s, v12.4s, v26.4s
                                trn2    v12.4s, v12.4s, v26.4s
                                ldr     q26, [x3, #64]
                                mls     v16.8h, v8.8h, v7.h[0]
                                ldr     q8, [x3, #80]
                                ldr     q24, [x3, #96]
                                trn1    v9.4s, v11.4s, v16.4s
                                trn2    v11.4s, v11.4s, v16.4s
                                ldr     q16, [x3, #112]
                                trn2    v6.2d, v0.2d, v9.2d
                                trn2    v3.2d, v12.2d, v11.2d
                                trn1    v0.2d, v0.2d, v9.2d
                                trn1    v12.2d, v12.2d, v11.2d
                                sub     v11.8h, v6.8h, v3.8h
                                sub     v9.8h, v0.8h, v12.8h
                                add     v12.8h, v0.8h, v12.8h
                                sqrdmulh        v0.8h, v11.8h, v15.h[5]
                                sqrdmulh        v4.8h, v9.8h, v15.h[3]
                                mul     v9.8h, v9.8h, v15.h[2]
                                mul     v11.8h, v11.8h, v15.h[4]
                                add     v6.8h, v6.8h, v3.8h
                                sqdmulh v3.8h, v12.8h, v7.h[1]
                                mls     v9.8h, v4.8h, v7.h[0]
                                mls     v11.8h, v0.8h, v7.h[0]
                                sqdmulh v0.8h, v6.8h, v7.h[1]
                                srshr   v3.8h, v3.8h, #11
                                sqdmulh v4.8h, v9.8h, v7.h[1]
                                sqdmulh v28.8h, v11.8h, v7.h[1]
                                mls     v12.8h, v3.8h, v7.h[0]
                                srshr   v0.8h, v0.8h, #11
                                srshr   v3.8h, v4.8h, #11
                                srshr   v4.8h, v28.8h, #11
                                mls     v6.8h, v0.8h, v7.h[0]
                                mls     v9.8h, v3.8h, v7.h[0]
                                mls     v11.8h, v4.8h, v7.h[0]
                                trn1    v0.4s, v24.4s, v16.4s
                                sub     v3.8h, v12.8h, v6.8h
                                add     v12.8h, v12.8h, v6.8h
                                sub     v6.8h, v9.8h, v11.8h
                                sqrdmulh        v4.8h, v3.8h, v15.h[1]
                                mul     v3.8h, v3.8h, v15.h[0]
                                sqrdmulh        v28.8h, v6.8h, v15.h[1]
                                mul     v15.8h, v6.8h, v15.h[0]
                                add     v11.8h, v9.8h, v11.8h
                                mls     v3.8h, v4.8h, v7.h[0]
                                str     q12, [x3], #64
                                mls     v15.8h, v28.8h, v7.h[0]
                                stur    q11, [x3, #-48]
                                ldr     q9, [x2], #96
                                stur    q3, [x3, #-32]
                                ldur    q6, [x2, #-80]
                                stur    q15, [x3, #-16]
                                ldur    q3, [x2, #-64]
                                ldur    q15, [x2, #-48]
                                ldur    q4, [x2, #-32]
                                ldur    q28, [x2, #-16]
                                sub     x4, x4, #0x1
                                cbnz    x4, layer3456_start
                                trn1    v11.4s, v26.4s, v8.4s
                                trn2    v24.4s, v24.4s, v16.4s
                                trn2    v26.4s, v26.4s, v8.4s
                                trn1    v18.2d, v11.2d, v0.2d
                                trn2    v11.2d, v11.2d, v0.2d
                                trn2    v12.2d, v26.2d, v24.2d
                                trn1    v8.2d, v26.2d, v24.2d
                                sub     v26.8h, v11.8h, v12.8h
                                sub     v13.8h, v18.8h, v8.8h
                                add     v24.8h, v18.8h, v8.8h
                                mul     v16.8h, v26.8h, v4.8h
                                sqrdmulh        v17.8h, v13.8h, v15.8h
                                mul     v3.8h, v13.8h, v3.8h
                                sqrdmulh        v26.8h, v26.8h, v28.8h
                                add     v10.8h, v11.8h, v12.8h
                                mls     v3.8h, v17.8h, v7.h[0]
                                mls     v16.8h, v26.8h, v7.h[0]
                                sub     v26.8h, v24.8h, v10.8h
                                ldr     q4, [x1], #16
                                sub     v12.8h, v3.8h, v16.8h
                                sqrdmulh        v15.8h, v26.8h, v6.8h
                                mul     v11.8h, v26.8h, v9.8h
                                mul     v8.8h, v12.8h, v9.8h
                                sqrdmulh        v12.8h, v12.8h, v6.8h
                                add     v0.8h, v24.8h, v10.8h
                                mls     v11.8h, v15.8h, v7.h[0]
                                add     v6.8h, v3.8h, v16.8h
                                mls     v8.8h, v12.8h, v7.h[0]
                                trn2    v26.4s, v0.4s, v6.4s
                                trn2    v12.4s, v11.4s, v8.4s
                                trn1    v3.4s, v11.4s, v8.4s
                                trn1    v17.4s, v0.4s, v6.4s
                                trn1    v8.2d, v26.2d, v12.2d
                                trn2    v13.2d, v26.2d, v12.2d
                                trn1    v11.2d, v17.2d, v3.2d
                                trn2    v15.2d, v17.2d, v3.2d
                                sub     v12.8h, v11.8h, v8.8h
                                add     v16.8h, v15.8h, v13.8h
                                sub     v26.8h, v15.8h, v13.8h
                                mul     v0.8h, v12.8h, v4.h[2]
                                sqrdmulh        v9.8h, v12.8h, v4.h[3]
                                mul     v13.8h, v26.8h, v4.h[4]
                                sqrdmulh        v26.8h, v26.8h, v4.h[5]
                                add     v24.8h, v11.8h, v8.8h
                                mls     v0.8h, v9.8h, v7.h[0]
                                sqdmulh v12.8h, v16.8h, v7.h[1]
                                mls     v13.8h, v26.8h, v7.h[0]
                                sqdmulh v11.8h, v24.8h, v7.h[1]
                                sqdmulh v8.8h, v0.8h, v7.h[1]
                                srshr   v12.8h, v12.8h, #11
                                sqdmulh v26.8h, v13.8h, v7.h[1]
                                srshr   v11.8h, v11.8h, #11
                                mls     v16.8h, v12.8h, v7.h[0]
                                srshr   v8.8h, v8.8h, #11
                                srshr   v26.8h, v26.8h, #11
                                mls     v24.8h, v11.8h, v7.h[0]
                                mls     v0.8h, v8.8h, v7.h[0]
                                mls     v13.8h, v26.8h, v7.h[0]
                                sub     v26.8h, v24.8h, v16.8h
                                add     v15.8h, v24.8h, v16.8h
                                sub     v12.8h, v0.8h, v13.8h
                                mul     v11.8h, v26.8h, v4.h[0]
                                sqrdmulh        v16.8h, v26.8h, v4.h[1]
                                mul     v26.8h, v12.8h, v4.h[0]
                                sqrdmulh        v8.8h, v12.8h, v4.h[1]
                                add     v12.8h, v0.8h, v13.8h
                                mls     v11.8h, v16.8h, v7.h[0]
                                str     q15, [x3], #64
                                mls     v26.8h, v8.8h, v7.h[0]
                                stur    q12, [x3, #-48]
                                stur    q11, [x3, #-32]
                                stur    q26, [x3, #-16]
                                mov     x4, #0x4
                                ldr     q0, [x1], #32
                                ldur    q1, [x1, #-16]
                                ldr     q24, [x0, #128]
                                ldr     q16, [x0, #192]
                                ldr     q9, [x0, #256]
                                ldr     q6, [x0, #320]
                                ldr     q3, [x0, #384]
                                ldr     q4, [x0, #448]
                                add     v28.8h, v9.8h, v6.8h
                                add     v19.8h, v24.8h, v16.8h
                                add     v13.8h, v3.8h, v4.8h
                                ldr     q11, [x0]
                                add     v23.8h, v28.8h, v13.8h
                                ldr     q15, [x0, #64]
                                sub     x4, x4, #0x1

layer012_start:
                                sub     v12.8h, v11.8h, v15.8h
                                add     v26.8h, v11.8h, v15.8h
                                sub     v8.8h, v24.8h, v16.8h
                                sqrdmulh        v11.8h, v12.8h, v0.h[7]
                                mul     v12.8h, v12.8h, v0.h[6]
                                sub     v16.8h, v26.8h, v19.8h
                                add     v26.8h, v26.8h, v19.8h
                                sqrdmulh        v15.8h, v8.8h, v1.h[1]
                                mul     v8.8h, v8.8h, v1.h[0]
                                mls     v12.8h, v11.8h, v7.h[0]
                                sub     v11.8h, v9.8h, v6.8h
                                sqrdmulh        v24.8h, v16.8h, v0.h[3]
                                mul     v16.8h, v16.8h, v0.h[2]
                                sub     v9.8h, v26.8h, v23.8h
                                add     v26.8h, v26.8h, v23.8h
                                mls     v8.8h, v15.8h, v7.h[0]
                                sqrdmulh        v15.8h, v11.8h, v1.h[3]
                                mul     v11.8h, v11.8h, v1.h[2]
                                sub     v6.8h, v3.8h, v4.8h
                                sub     v3.8h, v12.8h, v8.8h
                                add     v12.8h, v12.8h, v8.8h
                                mls     v11.8h, v15.8h, v7.h[0]
                                sqrdmulh        v8.8h, v6.8h, v1.h[5]
                                mls     v16.8h, v24.8h, v7.h[0]
                                mul     v15.8h, v6.8h, v1.h[4]
                                sqrdmulh        v24.8h, v3.8h, v0.h[3]
                                mul     v6.8h, v3.8h, v0.h[2]
                                sqrdmulh        v3.8h, v9.8h, v0.h[1]
                                mul     v9.8h, v9.8h, v0.h[0]
                                str     q26, [x0], #16
                                mls     v15.8h, v8.8h, v7.h[0]
                                mls     v6.8h, v24.8h, v7.h[0]
                                sub     v26.8h, v28.8h, v13.8h
                                mls     v9.8h, v3.8h, v7.h[0]
                                sub     v8.8h, v11.8h, v15.8h
                                sqrdmulh        v24.8h, v26.8h, v0.h[5]
                                mul     v26.8h, v26.8h, v0.h[4]
                                add     v11.8h, v11.8h, v15.8h
                                sqrdmulh        v15.8h, v8.8h, v0.h[5]
                                mul     v8.8h, v8.8h, v0.h[4]
                                mls     v26.8h, v24.8h, v7.h[0]
                                sub     v24.8h, v12.8h, v11.8h
                                add     v12.8h, v12.8h, v11.8h
                                mls     v8.8h, v15.8h, v7.h[0]
                                sqrdmulh        v11.8h, v24.8h, v0.h[1]
                                mul     v15.8h, v24.8h, v0.h[0]
                                sub     v24.8h, v16.8h, v26.8h
                                add     v26.8h, v16.8h, v26.8h
                                sub     v16.8h, v6.8h, v8.8h
                                mls     v15.8h, v11.8h, v7.h[0]
                                sqrdmulh        v11.8h, v24.8h, v0.h[1]
                                mul     v24.8h, v24.8h, v0.h[0]
                                add     v8.8h, v6.8h, v8.8h
                                sqrdmulh        v6.8h, v16.8h, v0.h[1]
                                mul     v16.8h, v16.8h, v0.h[0]
                                mls     v24.8h, v11.8h, v7.h[0]
                                str     q9, [x0, #240]
                                ldr     q11, [x0]
                                mls     v16.8h, v6.8h, v7.h[0]
                                str     q15, [x0, #304]
                                ldr     q15, [x0, #64]
                                str     q24, [x0, #368]
                                ldr     q24, [x0, #128]
                                str     q16, [x0, #432]
                                ldr     q16, [x0, #192]
                                str     q12, [x0, #48]
                                ldr     q9, [x0, #256]
                                ldr     q6, [x0, #320]
                                ldr     q3, [x0, #384]
                                ldr     q4, [x0, #448]
                                str     q26, [x0, #112]
                                add     v28.8h, v9.8h, v6.8h
                                add     v13.8h, v3.8h, v4.8h
                                str     q8, [x0, #176]
                                add     v19.8h, v24.8h, v16.8h
                                add     v23.8h, v28.8h, v13.8h
                                sub     x4, x4, #0x1
                                cbnz    x4, layer012_start
                                add     v10.8h, v11.8h, v15.8h
                                sub     v12.8h, v28.8h, v13.8h
                                sub     v11.8h, v11.8h, v15.8h
                                sub     v22.8h, v10.8h, v19.8h
                                mul     v18.8h, v12.8h, v0.h[4]
                                sqrdmulh        v26.8h, v12.8h, v0.h[5]
                                sqrdmulh        v12.8h, v22.8h, v0.h[3]
                                mul     v13.8h, v22.8h, v0.h[2]
                                sub     v31.8h, v24.8h, v16.8h
                                sqrdmulh        v22.8h, v11.8h, v0.h[7]
                                mls     v18.8h, v26.8h, v7.h[0]
                                mls     v13.8h, v12.8h, v7.h[0]
                                sqrdmulh        v2.8h, v31.8h, v1.h[1]
                                mul     v5.8h, v31.8h, v1.h[0]
                                mul     v15.8h, v11.8h, v0.h[6]
                                sub     v12.8h, v13.8h, v18.8h
                                sub     v4.8h, v3.8h, v4.8h
                                mls     v5.8h, v2.8h, v7.h[0]
                                sqrdmulh        v26.8h, v12.8h, v0.h[1]
                                mul     v12.8h, v12.8h, v0.h[0]
                                mls     v15.8h, v22.8h, v7.h[0]
                                sqrdmulh        v8.8h, v4.8h, v1.h[5]
                                mul     v4.8h, v4.8h, v1.h[4]
                                mls     v12.8h, v26.8h, v7.h[0]
                                sub     v21.8h, v15.8h, v5.8h
                                sub     v28.8h, v9.8h, v6.8h
                                mls     v4.8h, v8.8h, v7.h[0]
                                mul     v24.8h, v21.8h, v0.h[2]
                                sqrdmulh        v8.8h, v21.8h, v0.h[3]
                                sqrdmulh        v6.8h, v28.8h, v1.h[3]
                                add     v19.8h, v10.8h, v19.8h
                                mul     v28.8h, v28.8h, v1.h[2]
                                mls     v24.8h, v8.8h, v7.h[0]
                                sub     v11.8h, v19.8h, v23.8h
                                str     q12, [x0, #384]
                                mls     v28.8h, v6.8h, v7.h[0]
                                sqrdmulh        v16.8h, v11.8h, v0.h[1]
                                mul     v9.8h, v11.8h, v0.h[0]
                                add     v6.8h, v15.8h, v5.8h
                                add     v26.8h, v28.8h, v4.8h
                                sub     v15.8h, v28.8h, v4.8h
                                mls     v9.8h, v16.8h, v7.h[0]
                                add     v3.8h, v6.8h, v26.8h
                                mul     v8.8h, v15.8h, v0.h[4]
                                sqrdmulh        v15.8h, v15.8h, v0.h[5]
                                str     q9, [x0, #256]
                                sub     v2.8h, v6.8h, v26.8h
                                str     q3, [x0, #64]
                                mls     v8.8h, v15.8h, v7.h[0]
                                sqrdmulh        v15.8h, v2.8h, v0.h[1]
                                mul     v11.8h, v2.8h, v0.h[0]
                                add     v16.8h, v13.8h, v18.8h
                                sub     v12.8h, v24.8h, v8.8h
                                add     v8.8h, v24.8h, v8.8h
                                mls     v11.8h, v15.8h, v7.h[0]
                                sqrdmulh        v26.8h, v12.8h, v0.h[1]
                                mul     v12.8h, v12.8h, v0.h[0]
                                str     q8, [x0, #192]
                                add     v15.8h, v19.8h, v23.8h
                                str     q11, [x0, #320]
                                mls     v12.8h, v26.8h, v7.h[0]
                                str     q15, [x0], #16
                                str     q16, [x0, #112]
                                str     q12, [x0, #432]
                                ldp     d8, d9, [sp]
                                ldp     d10, d11, [sp, #16]
                                ldp     d12, d13, [sp, #32]
                                ldp     d14, d15, [sp, #48]
                                add     sp, sp, #0x40
                                ret
